<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REVTEC - Registrar Inspección</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

            .header-logo h1 {
                font-size: 1.5rem;
                color: #1e293b;
                font-weight: 700;
            }

            .header-logo img {
                width: 45px;
                height: 45px;
                border-radius: 50%;
                object-fit: cover;
            }

        .header-subtitle {
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 500;
        }

        .nav-menu {
            list-style: none;
            display: flex;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.9);
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            margin: 1rem 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

            .nav-menu a {
                text-decoration: none;
                color: #475569;
                font-weight: 500;
                padding: 0.5rem 1rem;
                border-radius: 6px;
                transition: all 0.2s;
            }

                .nav-menu a:hover {
                    background: #3b82f6;
                    color: white;
                }

        .main-container {
            flex: 1;
            padding: 2rem;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }

        .content-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .page-title {
            text-align: center;
            margin-bottom: 2rem;
            color: #1e293b;
            font-size: 1.75rem;
            font-weight: 700;
        }

        .search-section {
            background: rgba(59, 130, 246, 0.1);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border-left: 4px solid #3b82f6;
        }

        .search-title {
            margin: 0 0 1rem 0;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .search-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 1rem;
            align-items: end;
        }

        .form-group {
            margin: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.9);
        }

            .form-input:focus, .form-select:focus, .form-textarea:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                background: white;
            }

        .search-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.875rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
        }

            .search-button:hover {
                background: #2563eb;
                transform: translateY(-1px);
            }

            .search-button:disabled {
                opacity: 0.7;
                cursor: not-allowed;
                transform: none;
            }

        .placa-container {
            position: relative;
        }

        .placa-input {
            text-transform: uppercase;
        }

        .custom-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: background-color 0.2s;
        }

            .dropdown-item:hover {
                background: #f8fafc;
            }

            .dropdown-item:last-child {
                border-bottom: none;
            }

            .dropdown-item.selected {
                background: #3b82f6;
                color: white;
            }

        .vehicle-info {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        .no-results {
            padding: 1rem;
            text-align: center;
            color: #64748b;
            font-style: italic;
        }

        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .results-container {
            margin-top: 1rem;
        }

        .results-title {
            margin: 1rem 0 0.5rem 0;
            color: #1e293b;
            font-size: 1rem;
            font-weight: 600;
        }

        .appointment-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #3b82f6;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .appointment-info {
            flex: 1;
        }

        .appointment-vehicle {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .appointment-details {
            font-size: 0.9rem;
            color: #64748b;
        }

        .appointment-observations {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 0.25rem;
            font-style: italic;
        }

        .inspect-button {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

            .inspect-button:hover {
                background: #059669;
                transform: translateY(-1px);
            }

        .message-area {
            margin-top: 1.5rem;
            text-align: center;
            min-height: 40px;
        }

        .message {
            padding: 0.75rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            font-weight: 500;
        }

            .message.success {
                background: #dcfce7;
                color: #166534;
                border: 1px solid #bbf7d0;
            }

            .message.error {
                background: #fef2f2;
                color: #dc2626;
                border: 1px solid #fecaca;
            }

            .message.warning {
                background: #fefce8;
                color: #ca8a04;
                border: 1px solid #fde047;
            }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 0.5rem;
            }

            .nav-menu {
                margin: 0.5rem 1rem;
                justify-content: center;
            }

            .main-container {
                padding: 1rem;
            }

            .content-card {
                padding: 1.5rem;
            }

            .search-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .page-title {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-logo">
            <img src="39d17164-550e-4c01-a02a-60937f850308.jpg" alt="Logo REVTEC">
            <h1>REVTEC</h1>
        </div>
        <div class="header-subtitle">
            
        </div>
    </header>

    <ul class="nav-menu">
        <li><a href="PanelPrincipal.html"> Panel Principal</a></li>
    </ul>

    <main class="main-container">
        <div class="content-card">
            <h2 class="page-title"> Registrar Inspección Técnica</h2>

            <!-- Sección para buscar cita -->
            <div class="search-section">
                <h3 class="search-title"> Buscar Cita Programada</h3>

                <div class="search-grid">
                    <div class="form-group">
                        <label class="form-label"> Número de Placa</label>
                        <div class="placa-container">
                            <input type="text"
                                   id="buscarPlaca"
                                   class="form-input placa-input"
                                   placeholder="Escriba o seleccione..."
                                   autocomplete="off"
                                   onkeyup="filtrarPlacas()"
                                   onfocus="mostrarDropdown()"
                                   onblur="ocultarDropdown()">

                            <div id="placasDropdown" class="custom-dropdown">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label"> Fecha</label>
                        <input type="date" id="buscarFecha" class="form-input">
                    </div>

                    <div class="form-group">
                        <button type="button" onclick="buscarCitas()" class="search-button" id="botonBuscar">
                             Buscar
                        </button>
                    </div>
                </div>

                <div id="resultadosBusqueda" class="results-container"></div>
            </div>

            <div id="mensaje" class="message-area"></div>
        </div>
    </main>

    <script>
        const API_BASE = window.location.protocol + '//' + window.location.host + '/api';
        let vehiculosRegistrados = [];
        let citasProgramadas = [];
        let selectedIndex = -1;

        // Datos de ejemplo de vehículos registrados
        const vehiculosEjemplo = [
            { numeroPlaca: 'ABC123', marca: 'Toyota', modelo: 'Corolla', año: 2020, propietario: 'Juan Pérez' },
            { numeroPlaca: 'XYZ789', marca: 'Honda', modelo: 'Civic', año: 2019, propietario: 'María González' },
            { numeroPlaca: 'DEF456', marca: 'Nissan', modelo: 'Sentra', año: 2021, propietario: 'Carlos López' },
            { numeroPlaca: 'GHI123', marca: 'Hyundai', modelo: 'Elantra', año: 2022, propietario: 'Ana Rodríguez' },
            { numeroPlaca: 'JKL789', marca: 'Mazda', modelo: '3', año: 2020, propietario: 'Luis Martín' },
            { numeroPlaca: 'MNO456', marca: 'Kia', modelo: 'Forte', año: 2021, propietario: 'Elena Castro' },
            { numeroPlaca: 'PQR123', marca: 'Chevrolet', modelo: 'Onix', año: 2022, propietario: 'Roberto Silva' },
            { numeroPlaca: 'STU789', marca: 'Ford', modelo: 'Focus', año: 2019, propietario: 'Carmen Vargas' }
        ];

        // Citas de ejemplo para hoy
        const citasEjemplo = [
            { idCita: 1, numeroPlaca: 'ABC123', fecha: new Date().toISOString().split('T')[0], hora: '09:00', estacion: 'REVTEC San José Centro', observaciones: 'Primera inspección' },
            { idCita: 2, numeroPlaca: 'XYZ789', fecha: new Date().toISOString().split('T')[0], hora: '11:30', estacion: 'REVTEC San José Centro', observaciones: null },
            { idCita: 3, numeroPlaca: 'DEF456', fecha: new Date().toISOString().split('T')[0], hora: '14:00', estacion: 'REVTEC San José Centro', observaciones: 'Revisión de frenos' },
            { idCita: 4, numeroPlaca: 'GHI123', fecha: new Date().toISOString().split('T')[0], hora: '15:30', estacion: 'REVTEC San José Centro', observaciones: null },
            { idCita: 5, numeroPlaca: 'JKL789', fecha: new Date().toISOString().split('T')[0], hora: '16:45', estacion: 'REVTEC San José Centro', observaciones: 'Inspección de seguimiento' }
        ];

        // Inicializar página
        function inicializar() {
            console.log(' Inicializando página de inspección...');

            // Configurar fecha de hoy por defecto
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('buscarFecha').value = hoy;

            // Cargar vehículos (usar datos de ejemplo por ahora)
            vehiculosRegistrados = vehiculosEjemplo;
            citasProgramadas = citasEjemplo;

            console.log(` ${vehiculosRegistrados.length} vehículos cargados`);
            console.log(` ${citasProgramadas.length} citas programadas para hoy`);
        }

        // Filtrar placas según texto ingresado
        function filtrarPlacas() {
            const input = document.getElementById('buscarPlaca');
            const dropdown = document.getElementById('placasDropdown');
            const query = input.value.toUpperCase();

            // Si está vacío, mostrar todas las placas
            let vehiculosFiltrados = vehiculosRegistrados;

            if (query.length > 0) {
                vehiculosFiltrados = vehiculosRegistrados.filter(vehiculo =>
                    vehiculo.numeroPlaca.includes(query) ||
                    vehiculo.marca.toUpperCase().includes(query) ||
                    vehiculo.modelo.toUpperCase().includes(query)
                );
            }

            // Generar HTML del dropdown
            if (vehiculosFiltrados.length > 0) {
                dropdown.innerHTML = vehiculosFiltrados.map((vehiculo, index) => `
                        <div class="dropdown-item" data-index="${index}" onmousedown="seleccionarPlaca('${vehiculo.numeroPlaca}')">
                            <strong>${vehiculo.numeroPlaca}</strong>
                            <div class="vehicle-info">${vehiculo.marca} ${vehiculo.modelo} (${vehiculo.año}) - ${vehiculo.propietario}</div>
                        </div>
                    `).join('');
            } else {
                dropdown.innerHTML = '<div class="no-results"> No se encontraron vehículos</div>';
            }

            selectedIndex = -1;
            mostrarDropdown();
        }

        // Mostrar dropdown
        function mostrarDropdown() {
            const dropdown = document.getElementById('placasDropdown');
            dropdown.style.display = 'block';

            // Si no hay contenido, cargar todas las placas
            if (dropdown.children.length === 0) {
                filtrarPlacas();
            }
        }

        // Ocultar dropdown (con delay para permitir clics)
        function ocultarDropdown() {
            setTimeout(() => {
                document.getElementById('placasDropdown').style.display = 'none';
            }, 150);
        }

        // Seleccionar placa del dropdown
        function seleccionarPlaca(placa) {
            document.getElementById('buscarPlaca').value = placa;
            document.getElementById('placasDropdown').style.display = 'none';

            // Auto-buscar si hay fecha seleccionada
            const fecha = document.getElementById('buscarFecha').value;
            if (fecha) {
                buscarCitas();
            }
        }

        // Manejo de teclado en el dropdown
        document.getElementById('buscarPlaca').addEventListener('keydown', function (e) {
            const dropdown = document.getElementById('placasDropdown');
            const items = dropdown.querySelectorAll('.dropdown-item:not(.no-results)');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateSelectedItem(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelectedItem(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && items[selectedIndex]) {
                    const placa = items[selectedIndex].querySelector('strong').textContent;
                    seleccionarPlaca(placa);
                } else {
                    buscarCitas();
                }
            } else if (e.key === 'Escape') {
                ocultarDropdown();
            }
        });

        function updateSelectedItem(items) {
            items.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // Buscar citas
        function buscarCitas() {
            const placa = document.getElementById('buscarPlaca').value.trim().toUpperCase();
            const fecha = document.getElementById('buscarFecha').value;
            const resultados = document.getElementById('resultadosBusqueda');
            const boton = document.getElementById('botonBuscar');

            if (!placa && !fecha) {
                mostrarMensaje(' Ingrese al menos la placa o la fecha para buscar', 'warning');
                return;
            }

            // Mostrar loading
            boton.innerHTML = '<span class="loading-spinner"></span>Buscando...';
            boton.disabled = true;

            // Simular búsqueda
            setTimeout(() => {
                let citasEncontradas = citasProgramadas;

                // Filtrar por placa si se especifica
                if (placa) {
                    citasEncontradas = citasEncontradas.filter(c => c.numeroPlaca === placa);
                }

                // Filtrar por fecha si se especifica
                if (fecha) {
                    citasEncontradas = citasEncontradas.filter(c => c.fecha === fecha);
                }

                mostrarResultados(citasEncontradas);

                // Restaurar botón
                boton.innerHTML = ' Buscar';
                boton.disabled = false;
            }, 500);
        }

        // Mostrar resultados de búsqueda
        function mostrarResultados(citas) {
            const resultados = document.getElementById('resultadosBusqueda');

            if (citas.length === 0) {
                resultados.innerHTML = '<div class="message warning"> No se encontraron citas programadas con esos criterios</div>';
                return;
            }

            let html = '<h4 class="results-title"> Citas encontradas:</h4>';

            citas.forEach(cita => {
                const vehiculo = vehiculosRegistrados.find(v => v.numeroPlaca === cita.numeroPlaca);

                html += `
                        <div class="appointment-card">
                            <div class="appointment-info">
                                <div class="appointment-vehicle">
                                     ${cita.numeroPlaca} - ${vehiculo?.marca || ''} ${vehiculo?.modelo || ''}
                                </div>
                                <div class="appointment-details">
                                     ${new Date(cita.fecha).toLocaleDateString('es-ES')} |  ${cita.hora} |  ${cita.estacion}
                                </div>
                                ${cita.observaciones ? `<div class="appointment-observations"> ${cita.observaciones}</div>` : ''}
                            </div>
                            <button onclick="iniciarInspeccion(${cita.idCita}, '${cita.numeroPlaca}')" class="inspect-button">
                                 Inspeccionar
                            </button>
                        </div>
                    `;
            });

            resultados.innerHTML = html;
        }

        // Iniciar inspección
        function iniciarInspeccion(idCita, placa) {
            mostrarMensaje(` Iniciando inspección para vehículo ${placa}...`, 'success');

            // Aquí se abriría el formulario de inspección
            // Por ahora, simular redirección
            setTimeout(() => {
                alert(`Inspección iniciada para vehículo ${placa}\n\nEn la versión completa, esto abriría el formulario de inspección con todos los checklist técnicos.`);
            }, 1000);
        }

        // Mostrar mensaje
        function mostrarMensaje(texto, tipo) {
            const mensaje = document.getElementById('mensaje');
            mensaje.innerHTML = `<div class="message ${tipo}">${texto}</div>`;

            // Auto-limpiar después de 5 segundos
            setTimeout(() => {
                mensaje.innerHTML = '';
            }, 5000);
        }

        // Inicializar al cargar la página
        document.addEventListener('DOMContentLoaded', inicializar);
    </script>
</body>
</html>