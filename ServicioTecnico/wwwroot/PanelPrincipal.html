<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REVTEC - Panel Principal</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

            .header-logo h1 {
                font-size: 1.5rem;
                color: #1e293b;
                font-weight: 700;
            }

            .header-logo img {
                width: 45px;
                height: 45px;
                border-radius: 50%;
                object-fit: cover;
            }

        .nav-menu {
            list-style: none;
            display: flex;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.9);
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            margin: 1rem 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

            .nav-menu a {
                text-decoration: none;
                color: #475569;
                font-weight: 500;
                padding: 0.5rem 1rem;
                border-radius: 6px;
                transition: all 0.2s;
                cursor: pointer;
            }

                .nav-menu a:hover {
                    background: #ef4444;
                    color: white;
                }

        .welcome-section {
            text-align: center;
            padding: 2rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            background: rgba(255, 255, 255, 0.9);
            margin: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .debug-info {
            background: rgba(16, 185, 129, 0.1);
            padding: 1rem;
            margin: 1rem 2rem;
            border-radius: 8px;
            border-left: 4px solid #10b981;
            font-family: monospace;
            font-size: 0.9rem;
            display: none;
        }

        .panel-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: none;
        }

            .panel-section.active {
                display: block;
            }

        .panel-title {
            margin-bottom: 1.5rem;
            color: #1e293b;
            font-weight: 700;
            font-size: 1.5rem;
        }

        .panel-links {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .panel-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            text-decoration: none;
            color: #374151;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

            .panel-link:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            }

            .panel-link.cliente:hover {
                background: #059669;
                color: white;
                border-color: #059669;
            }

            .panel-link.tecnico:hover {
                background: #7c3aed;
                color: white;
                border-color: #7c3aed;
            }

        .summary-section {
            margin-top: 2rem;
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid #3b82f6;
        }

            .summary-section.cliente {
                background: rgba(16, 185, 129, 0.1);
                border-left-color: #10b981;
            }

            .summary-section.tecnico {
                background: rgba(139, 92, 246, 0.1);
                border-left-color: #8b5cf6;
            }

        .summary-title {
            margin: 0 0 1rem 0;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .stat-card {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
        }

        .loading-section {
            text-align: center;
            margin: 2rem;
            color: #64748b;
        }

        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #e5e7eb;
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .citas-section {
            margin-top: 1.5rem;
        }

        .citas-title {
            margin: 0 0 1rem 0;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .cita-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 0.75rem;
            border-left: 4px solid #3b82f6;
        }

        .cita-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .cita-vehicle {
            font-weight: 600;
            color: #1e293b;
        }

        .cita-time {
            background: #3b82f6;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .cita-details {
            font-size: 0.9rem;
            color: #64748b;
        }

        .cita-observations {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 0.5rem;
            font-style: italic;
        }

        .no-data {
            text-align: center;
            color: #64748b;
            font-style: italic;
            padding: 2rem;
        }

        .no-data-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 0.5rem;
            }

            .nav-menu {
                margin: 0.5rem 1rem;
                justify-content: center;
            }

            .panel-section {
                margin: 1rem;
                padding: 1.5rem;
            }

            .panel-links {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-logo">
            <img src="39d17164-550e-4c01-a02a-60937f850308.jpg" alt="Logo REVTEC">
            <h1>REVTEC</h1>
        </div>
    </header>

    <ul class="nav-menu">
        <li><a href="#" onclick="cerrarSesion()"> Cerrar Sesión</a></li>
    </ul>

    <div id="bienvenida" class="welcome-section">
        <span> Cargando información...</span>
    </div>

    <!-- Información de Debug -->
    <div id="debugInfo" class="debug-info">
        <strong> Debug:</strong> <span id="debugText">Verificando usuario...</span>
    </div>

    <!-- Loading -->
    <div id="loadingSection" class="loading-section">
        <div class="loading-spinner"></div>
        <p>Cargando datos del usuario...</p>
    </div>

    <!-- Panel del Cliente -->
    <div class="panel-section" id="panelCliente">
        <h2 class="panel-title"> Panel del Cliente</h2>

        <div class="panel-links">
            <a href="RegistroVehiculo.html" class="panel-link cliente">
                 Registrar Vehículo
            </a>
            <a href="MisVehiculos.html" class="panel-link cliente">
                 Mis Vehículos
            </a>
            <a href="AgendarCita.html" class="panel-link cliente">
                 Agendar Cita
            </a>
            <a href="HistorialInspecciones.html" class="panel-link cliente">
                 Ver Historial Inspecciones
            </a>
        </div>

        <div class="summary-section cliente">
            <h3 class="summary-title"> Resumen de mi Cuenta</h3>
            <div class="stats-grid" id="statsCliente">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>

        <!-- Sección de citas próximas -->
        <div class="citas-section" id="citasProximasSection">
            <h3 class="citas-title"> Mis Próximas Citas</h3>
            <div id="citasProximasContainer">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Panel del Técnico -->
    <div class="panel-section" id="panelTecnico">
        <h2 class="panel-title"> Panel del Técnico</h2>

        <div class="panel-links">
            <a href="RegistrarInspeccion.html" class="panel-link tecnico">
                 Registrar Inspección
            </a>
            <a href="HistorialInspecciones.html" class="panel-link tecnico">
                 Ver Mis Inspecciones
            </a>
        </div>

        <div class="summary-section tecnico">
            <h3 class="summary-title"> Actividad del Día</h3>
            <div class="stats-grid" id="statsTecnico">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>

        <div class="citas-section" id="citasHoySection">
            <h3 class="citas-title"> Citas de Hoy</h3>
            <div id="citasHoyContainer">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.protocol + '//' + window.location.host + '/api';
        let usuario = null;

        function cerrarSesion() {
            if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
                localStorage.removeItem('usuarioActual');
                window.location.href = 'Login.html';
            }
        }

        function mostrarDebug(mensaje) {
            document.getElementById('debugText').textContent = mensaje;
            document.getElementById('debugInfo').style.display = 'block';
            console.log(' DEBUG:', mensaje);
        }

        // Función para cargar datos del cliente
        async function cargarDatosCliente() {
            try {
                mostrarDebug(`Cargando datos para cliente ID: ${usuario.id}`);

                // Cargar vehículos del usuario
                const vehiculosResponse = await fetch(`${API_BASE}/Vehiculo/porPropietario/${usuario.id}`);
                const vehiculos = vehiculosResponse.ok ? await vehiculosResponse.json() : [];

                // Cargar todas las citas y filtrar las del usuario
                const citasResponse = await fetch(`${API_BASE}/Cita`);
                const todasCitas = citasResponse.ok ? await citasResponse.json() : [];

                const citasUsuario = todasCitas.filter(cita =>
                    vehiculos.some(vehiculo => vehiculo.idVehiculo === cita.idVehiculo)
                );

                // Cargar inspecciones y certificados
                const inspeccionesResponse = await fetch(`${API_BASE}/Inspeccion`);
                const todasInspecciones = inspeccionesResponse.ok ? await inspeccionesResponse.json() : [];

                const inspeccionesUsuario = todasInspecciones.filter(inspeccion =>
                    citasUsuario.some(cita => cita.idCita === inspeccion.idCita)
                );

                const certificadosResponse = await fetch(`${API_BASE}/Certificado`);
                const todosCertificados = certificadosResponse.ok ? await certificadosResponse.json() : [];

                const certificadosUsuario = todosCertificados.filter(certificado =>
                    inspeccionesUsuario.some(inspeccion => inspeccion.idInspeccion === certificado.idInspeccion)
                );

                // Calcular estadísticas
                const citasPendientes = citasUsuario.filter(c => c.estadoCita === 'programada').length;
                const inspeccionesTotales = inspeccionesUsuario.length;
                const certificadosValidos = certificadosUsuario.filter(c =>
                    new Date(c.fechaVencimiento) > new Date() && c.estadoCertificado === 'valido'
                ).length;

                // Mostrar estadísticas
                document.getElementById('statsCliente').innerHTML = `
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-value" style="color: #3b82f6;">${vehiculos.length}</div>
                            <div class="stat-label">Mis Vehículos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-value" style="color: #f59e0b;">${citasPendientes}</div>
                            <div class="stat-label">Citas Pendientes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-value" style="color: #8b5cf6;">${inspeccionesTotales}</div>
                            <div class="stat-label">Inspecciones</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-value" style="color: #10b981;">${certificadosValidos}</div>
                            <div class="stat-label">Certificados Válidos</div>
                        </div>
                    `;

                // Mostrar próximas citas
                await mostrarProximasCitas(citasUsuario, vehiculos);

                mostrarDebug(`Datos cargados: ${vehiculos.length} vehículos, ${citasPendientes} citas pendientes`);

            } catch (error) {
                console.error('Error al cargar datos del cliente:', error);
                mostrarDebug(`Error: ${error.message}`);

                // Mostrar datos por defecto en caso de error
                document.getElementById('statsCliente').innerHTML = `
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-value" style="color: #ef4444;">Error</div>
                            <div class="stat-label">Error al cargar</div>
                        </div>
                    `;
            }
        }

        // Función para mostrar próximas citas
        async function mostrarProximasCitas(citasUsuario, vehiculos) {
            try {
                // Obtener estaciones
                const estacionesResponse = await fetch(`${API_BASE}/Estacion`);
                const estaciones = estacionesResponse.ok ? await estacionesResponse.json() : [];

                // Filtrar citas futuras y programadas
                const ahora = new Date();
                const citasProximas = citasUsuario
                    .filter(cita => {
                        const fechaCita = new Date(cita.fechaCita);
                        return fechaCita >= ahora && cita.estadoCita === 'programada';
                    })
                    .sort((a, b) => new Date(a.fechaCita) - new Date(b.fechaCita))
                    .slice(0, 5); // Mostrar máximo 5

                const container = document.getElementById('citasProximasContainer');

                if (citasProximas.length === 0) {
                    container.innerHTML = `
                            <div class="no-data">
                                <div class="no-data-icon"></div>
                                <p>No tienes citas programadas próximamente</p>
                                <p style="margin-top: 0.5rem;"><a href="AgendarCita.html" style="color: #3b82f6;">¿Deseas agendar una cita?</a></p>
                            </div>
                        `;
                    return;
                }

                container.innerHTML = citasProximas.map(cita => {
                    const vehiculo = vehiculos.find(v => v.idVehiculo === cita.idVehiculo);
                    const estacion = estaciones.find(e => e.idEstacion === cita.idEstacion);
                    const fechaFormateada = new Date(cita.fechaCita).toLocaleDateString('es-ES');
                    const horaFormateada = formatearHora(cita.horaCita);

                    return `
                            <div class="cita-card">
                                <div class="cita-header">
                                    <div class="cita-vehicle">
                                         ${vehiculo?.numeroPlaca || 'N/A'} - ${vehiculo?.marca || ''} ${vehiculo?.modelo || ''}
                                    </div>
                                    <div class="cita-time"> ${fechaFormateada} ⏰ ${horaFormateada}</div>
                                </div>
                                <div class="cita-details">
                                     ${estacion?.nombreEstacion || 'Estación no encontrada'}
                                </div>
                                ${cita.observaciones ? `<div class="cita-observations"> ${cita.observaciones}</div>` : ''}
                            </div>
                        `;
                }).join('');

            } catch (error) {
                console.error('Error al cargar próximas citas:', error);
                document.getElementById('citasProximasContainer').innerHTML = `
                        <div class="no-data">
                            <div class="no-data-icon"></div>
                            <p>Error al cargar las citas</p>
                        </div>
                    `;
            }
        }

        // Función para cargar datos del técnico
        async function cargarDatosTecnico() {
            try {
                mostrarDebug(`Cargando datos para técnico ID: ${usuario.id}`);

                // Cargar inspecciones del técnico
                const inspeccionesResponse = await fetch(`${API_BASE}/Inspeccion`);
                const todasInspecciones = inspeccionesResponse.ok ? await inspeccionesResponse.json() : [];

                const inspeccionesTecnico = todasInspecciones.filter(i => i.idTecnico === usuario.id);

                // Cargar citas de hoy
                const citasResponse = await fetch(`${API_BASE}/Cita`);
                const todasCitas = citasResponse.ok ? await citasResponse.json() : [];

                const hoy = new Date().toISOString().split('T')[0];
                const citasHoy = todasCitas.filter(c => c.fechaCita.split('T')[0] === hoy);

                // Estadísticas del día
                const inspeccionesHoy = inspeccionesTecnico.filter(i =>
                    i.fechaInspeccion.split('T')[0] === hoy
                ).length;

                const inspeccionesAprobadas = inspeccionesTecnico.filter(i =>
                    i.fechaInspeccion.split('T')[0] === hoy && i.resultado === 'aprobado'
                ).length;

                // Mostrar estadísticas
                document.getElementById('statsTecnico').innerHTML = `
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-value" style="color: #3b82f6;">${citasHoy.length}</div>
                            <div class="stat-label">Citas Hoy</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-value" style="color: #8b5cf6;">${inspeccionesHoy}</div>
                            <div class="stat-label">Inspecciones Hoy</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-value" style="color: #10b981;">${inspeccionesAprobadas}</div>
                            <div class="stat-label">Aprobadas Hoy</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-value" style="color: #f59e0b;">${inspeccionesTecnico.length}</div>
                            <div class="stat-label">Total Inspecciones</div>
                        </div>
                    `;

                // Mostrar citas de hoy
                await mostrarCitasHoy(citasHoy);

                mostrarDebug(`Datos técnico cargados: ${inspeccionesTecnico.length} inspecciones totales`);

            } catch (error) {
                console.error('Error al cargar datos del técnico:', error);
                mostrarDebug(`Error: ${error.message}`);
            }
        }

        // Función para mostrar citas de hoy
        async function mostrarCitasHoy(citasHoy) {
            try {
                const vehiculosResponse = await fetch(`${API_BASE}/Vehiculo`);
                const vehiculos = vehiculosResponse.ok ? await vehiculosResponse.json() : [];

                const estacionesResponse = await fetch(`${API_BASE}/Estacion`);
                const estaciones = estacionesResponse.ok ? await estacionesResponse.json() : [];

                const container = document.getElementById('citasHoyContainer');

                if (citasHoy.length === 0) {
                    container.innerHTML = `
                            <div class="no-data">
                                <div class="no-data-icon"></div>
                                <p>No hay citas programadas para hoy</p>
                            </div>
                        `;
                    return;
                }

                // Ordenar por hora
                citasHoy.sort((a, b) => a.horaCita.localeCompare(b.horaCita));

                container.innerHTML = citasHoy.map(cita => {
                    const vehiculo = vehiculos.find(v => v.idVehiculo === cita.idVehiculo);
                    const estacion = estaciones.find(e => e.idEstacion === cita.idEstacion);
                    const horaFormateada = formatearHora(cita.horaCita);

                    return `
                            <div class="cita-card">
                                <div class="cita-header">
                                    <div class="cita-vehicle">
                                         ${vehiculo?.numeroPlaca || 'N/A'} - ${vehiculo?.marca || ''} ${vehiculo?.modelo || ''}
                                    </div>
                                    <div class="cita-time">⏰ ${horaFormateada}</div>
                                </div>
                                <div class="cita-details">
                                     ${estacion?.nombreEstacion || 'Estación no encontrada'}
                                </div>
                                ${cita.observaciones ? `<div class="cita-observations">📝 ${cita.observaciones}</div>` : ''}
                            </div>
                        `;
                }).join('');

            } catch (error) {
                console.error('Error al cargar citas de hoy:', error);
                document.getElementById('citasHoyContainer').innerHTML = `
                        <div class="no-data">
                            <div class="no-data-icon">❌</div>
                            <p>Error al cargar las citas</p>
                        </div>
                    `;
            }
        }

        // Función para formatear hora
        function formatearHora(timeSpan) {
            if (typeof timeSpan === 'string') {
                if (timeSpan.includes(':')) {
                    const partes = timeSpan.split(':');
                    const hora = parseInt(partes[0]);
                    const minuto = partes[1];
                    const ampm = hora >= 12 ? 'PM' : 'AM';
                    const hora12 = hora % 12 || 12;
                    return `${hora12}:${minuto} ${ampm}`;
                }
            }
            return timeSpan;
        }

        async function inicializar() {
            console.log(' Inicializando panel principal...');
            mostrarDebug('Verificando sesión de usuario...');

            try {
                // Verificar localStorage
                const usuarioData = localStorage.getItem('usuarioActual');

                if (!usuarioData) {
                    mostrarDebug(' No hay datos de usuario');
                    setTimeout(() => window.location.href = 'Login.html', 2000);
                    return;
                }

                usuario = JSON.parse(usuarioData);
                mostrarDebug(` Usuario: ${usuario.nombre} ${usuario.apellidos} (${usuario.tipoUsuario})`);

                // Mostrar bienvenida
                const horaActual = new Date().getHours();
                let saludo = '';
                if (horaActual < 12) saludo = ' Buenos días';
                else if (horaActual < 18) saludo = ' Buenas tardes';
                else saludo = ' Buenas noches';

                const nombreCompleto = `${usuario.nombre || ''} ${usuario.apellidos || ''}`.trim();
                document.getElementById('bienvenida').innerHTML = `${saludo}, <strong>${nombreCompleto}</strong>!`;

                // Ocultar loading
                document.getElementById('loadingSection').style.display = 'none';

                // Mostrar panel correcto según tipo de usuario
                if (usuario.tipoUsuario === 'cliente') {
                    mostrarDebug(' Mostrando panel de cliente');
                    document.getElementById('panelCliente').classList.add('active');
                    await cargarDatosCliente();

                    // Ocultar debug después de 5 segundos para clientes
                    setTimeout(() => {
                        document.getElementById('debugInfo').style.display = 'none';
                    }, 5000);

                } else if (usuario.tipoUsuario === 'tecnico') {
                    mostrarDebug(' Mostrando panel de técnico');
                    document.getElementById('panelTecnico').classList.add('active');
                    await cargarDatosTecnico();

                    // Mantener debug visible para técnicos por más tiempo
                    setTimeout(() => {
                        document.getElementById('debugInfo').style.display = 'none';
                    }, 8000);

                } else {
                    mostrarDebug(` Tipo de usuario desconocido: ${usuario.tipoUsuario}`);
                    // Por defecto mostrar panel de cliente
                    document.getElementById('panelCliente').classList.add('active');
                    await cargarDatosCliente();
                }

                console.log(' Panel configurado correctamente');

            } catch (error) {
                console.error(' Error:', error);
                mostrarDebug(` Error: ${error.message}`);

                // Limpiar datos corruptos
                localStorage.removeItem('usuarioActual');
                setTimeout(() => window.location.href = 'Login.html', 3000);
            }
        }

        // Ejecutar al cargar
        document.addEventListener('DOMContentLoaded', inicializar);

        // También ejecutar inmediatamente si ya está cargado
        if (document.readyState !== 'loading') {
            inicializar();
        }
    </script>
</body>
</html>