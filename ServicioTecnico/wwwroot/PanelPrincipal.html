<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REVTEC - Panel Principal</title>
    <link rel="stylesheet" href="Login.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>
    <header>
        <div class="header-logo">
            <img src="39d17164-550e-4c01-a02a-60937f850308.jpg" alt="Logo REVTEC" style="height: 45px; width: 45px; border-radius: 50%; object-fit: cover;">
            <h1 style="font-size: 1.4rem; margin: 0 0 0 0.75rem;">REVTEC</h1>
        </div>
        <div style="font-size: 0.9rem; color: #64748b; font-weight: 500;">
            Panel de Control
        </div>
    </header>

    <ul>
        <li><a href="#" onclick="cerrarSesion()">🚪 Cerrar Sesión</a></li>
    </ul>

    <div id="bienvenida"></div>

    <!-- Panel del Cliente -->
    <div class="panel-section" id="panelCliente" style="display: none;">
        <h2>👤 Panel del Cliente</h2>
        <div class="panel-links">
            <a href="RegistroVehiculo.html">
                🚗 Registrar Vehículo
            </a>
            <a href="AgendarCita.html">
                📅 Agendar Cita
            </a>
            <a href="HistorialInspecciones.html">
                📋 Ver Historial
            </a>
        </div>

        <!-- Resumen rápido para cliente -->
        <div id="resumenCliente" style="margin-top: 2rem; padding: 1.5rem; background: rgba(59, 130, 246, 0.1); border-radius: 12px; border-left: 4px solid #3b82f6;">
            <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.1rem;">📊 Resumen Rápido</h3>
            <div id="estadisticasCliente" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Panel del Técnico -->
    <div class="panel-section" id="panelTecnico" style="display: none;">
        <h2>🔧 Panel del Técnico</h2>
        <div class="panel-links">
            <a href="RegistrarInspeccion.html">
                ✅ Registrar Inspección
            </a>
            <a href="HistorialInspecciones.html">
                📈 Ver Inspecciones
            </a>
        </div>

        <!-- Resumen rápido para técnico -->
        <div id="resumenTecnico" style="margin-top: 2rem; padding: 1.5rem; background: rgba(139, 92, 246, 0.1); border-radius: 12px; border-left: 4px solid #8b5cf6;">
            <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.1rem;">📊 Actividad del Día</h3>
            <div id="estadisticasTecnico" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>

        <!-- Citas de hoy -->
        <div id="citasHoy" style="margin-top: 1.5rem;">
            <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.1rem;">📅 Citas de Hoy</h3>
            <div id="listaCitasHoy">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let usuario = null;

        // Verificar si el usuario está logueado
        function verificarSesion() {
            const usuarioActual = localStorage.getItem('usuarioActual');

            if (!usuarioActual) {
                window.location.href = 'Login.html';
                return null;
            }

            return JSON.parse(usuarioActual);
        }

        function cerrarSesion() {
            if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
                localStorage.removeItem('usuarioActual');
                window.location.href = 'Login.html';
            }
        }

        // Cargar estadísticas para cliente
        async function cargarEstadisticasCliente() {
            try {
                const [vehiculosRes, citasRes, inspeccionesRes, certificadosRes] = await Promise.all([
                    fetch(`${API_BASE}/Vehiculo/porPropietario/${usuario.id}`),
                    fetch(`${API_BASE}/Cita`),
                    fetch(`${API_BASE}/Inspeccion`),
                    fetch(`${API_BASE}/Certificado`)
                ]);

                const vehiculos = await vehiculosRes.json();
                const todasCitas = await citasRes.json();
                const todasInspecciones = await inspeccionesRes.json();
                const todosCertificados = await certificadosRes.json();

                // Filtrar citas del usuario
                const citasUsuario = todasCitas.filter(c =>
                    vehiculos.some(v => v.idVehiculo === c.idVehiculo)
                );

                // Filtrar inspecciones del usuario
                const inspeccionesUsuario = todasInspecciones.filter(i =>
                    citasUsuario.some(c => c.idCita === i.idCita)
                );

                // Certificados válidos
                const certificadosValidos = todosCertificados.filter(cert => {
                    const esDelUsuario = inspeccionesUsuario.some(i => i.idInspeccion === cert.idInspeccion);
                    const esValido = new Date(cert.fechaVencimiento) > new Date();
                    return esDelUsuario && esValido && cert.estadoCertificado === 'valido';
                });

                // Citas pendientes
                const citasPendientes = citasUsuario.filter(c => c.estadoCita === 'programada');

                const stats = [
                    { titulo: 'Vehículos', valor: vehiculos.length, icono: '🚗', color: '#3b82f6' },
                    { titulo: 'Citas Pendientes', valor: citasPendientes.length, icono: '📅', color: '#f59e0b' },
                    { titulo: 'Inspecciones', valor: inspeccionesUsuario.length, icono: '🔍', color: '#8b5cf6' },
                    { titulo: 'Certificados Válidos', valor: certificadosValidos.length, icono: '✅', color: '#10b981' }
                ];

                const contenedor = document.getElementById('estadisticasCliente');
                contenedor.innerHTML = stats.map(stat => `
                        <div style="text-align: center; padding: 1rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">${stat.icono}</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${stat.color}; margin-bottom: 0.25rem;">${stat.valor}</div>
                            <div style="font-size: 0.875rem; color: #64748b; font-weight: 500;">${stat.titulo}</div>
                        </div>
                    `).join('');

            } catch (error) {
                console.error('Error al cargar estadísticas:', error);
                document.getElementById('estadisticasCliente').innerHTML =
                    '<p style="color: #ef4444;">Error al cargar estadísticas</p>';
            }
        }

        // Cargar estadísticas para técnico
        async function cargarEstadisticasTecnico() {
            try {
                const [citasRes, inspeccionesRes] = await Promise.all([
                    fetch(`${API_BASE}/Cita`),
                    fetch(`${API_BASE}/Inspeccion`)
                ]);

                const todasCitas = await citasRes.json();
                const todasInspecciones = await inspeccionesRes.json();

                const hoy = new Date().toISOString().split('T')[0];

                // Citas de hoy
                const citasHoy = todasCitas.filter(c =>
                    c.fechaCita.split('T')[0] === hoy && c.estadoCita === 'programada'
                );

                // Inspecciones del técnico
                const inspeccionesTecnico = todasInspecciones.filter(i => i.idTecnico === usuario.id);

                // Inspecciones de hoy
                const inspeccionesHoy = inspeccionesTecnico.filter(i =>
                    i.fechaInspeccion.split('T')[0] === hoy
                );

                // Inspecciones aprobadas hoy
                const aprobadasHoy = inspeccionesHoy.filter(i => i.resultado === 'aprobado').length;

                const stats = [
                    { titulo: 'Citas Hoy', valor: citasHoy.length, icono: '📅', color: '#3b82f6' },
                    { titulo: 'Inspecciones Hoy', valor: inspeccionesHoy.length, icono: '🔍', color: '#8b5cf6' },
                    { titulo: 'Aprobadas Hoy', valor: aprobadasHoy, icono: '✅', color: '#10b981' },
                    { titulo: 'Total Inspecciones', valor: inspeccionesTecnico.length, icono: '📊', color: '#f59e0b' }
                ];

                const contenedor = document.getElementById('estadisticasTecnico');
                contenedor.innerHTML = stats.map(stat => `
                        <div style="text-align: center; padding: 1rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">${stat.icono}</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${stat.color}; margin-bottom: 0.25rem;">${stat.valor}</div>
                            <div style="font-size: 0.875rem; color: #64748b; font-weight: 500;">${stat.titulo}</div>
                        </div>
                    `).join('');

                // Mostrar citas de hoy
                await mostrarCitasHoy(citasHoy);

            } catch (error) {
                console.error('Error al cargar estadísticas:', error);
                document.getElementById('estadisticasTecnico').innerHTML =
                    '<p style="color: #ef4444;">Error al cargar estadísticas</p>';
            }
        }

        // Mostrar citas de hoy para técnico
        async function mostrarCitasHoy(citasHoy) {
            try {
                if (citasHoy.length === 0) {
                    document.getElementById('listaCitasHoy').innerHTML =
                        '<p style="text-align: center; color: #64748b; font-style: italic;">No hay citas programadas para hoy</p>';
                    return;
                }

                const [vehiculosRes, estacionesRes] = await Promise.all([
                    fetch(`${API_BASE}/Vehiculo`),
                    fetch(`${API_BASE}/Estacion`)
                ]);

                const vehiculos = await vehiculosRes.json();
                const estaciones = await estacionesRes.json();

                const citasHTML = citasHoy.map(cita => {
                    const vehiculo = vehiculos.find(v => v.idVehiculo === cita.idVehiculo);
                    const estacion = estaciones.find(e => e.idEstacion === cita.idEstacion);

                    return `
                            <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 0.75rem; border-left: 4px solid #3b82f6;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <strong style="color: #1e293b;">${vehiculo?.numeroPlaca || 'N/A'} - ${vehiculo?.marca || ''} ${vehiculo?.modelo || ''}</strong>
                                    <span style="background: #3b82f6; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500;">
                                        ${cita.horaCita}
                                    </span>
                                </div>
                                <div style="font-size: 0.9rem; color: #64748b;">
                                    📍 ${estacion?.nombreEstacion || 'N/A'}
                                </div>
                                ${cita.observaciones ? `<div style="font-size: 0.85rem; color: #64748b; margin-top: 0.5rem; font-style: italic;">💬 ${cita.observaciones}</div>` : ''}
                            </div>
                        `;
                }).join('');

                document.getElementById('listaCitasHoy').innerHTML = citasHTML;

            } catch (error) {
                console.error('Error al cargar citas:', error);
                document.getElementById('listaCitasHoy').innerHTML =
                    '<p style="color: #ef4444;">Error al cargar citas de hoy</p>';
            }
        }

        // Función principal de inicialización
        async function inicializar() {
            usuario = verificarSesion();
            if (!usuario) return;

            // Mostrar bienvenida personalizada
            const horaActual = new Date().getHours();
            let saludo = '';
            if (horaActual < 12) saludo = '🌅 Buenos días';
            else if (horaActual < 18) saludo = '☀️ Buenas tardes';
            else saludo = '🌙 Buenas noches';

            document.getElementById('bienvenida').innerHTML =
                `${saludo}, <strong>${usuario.nombre} ${usuario.apellidos}</strong>!`;

            // Mostrar panel según tipo de usuario y cargar datos
            if (usuario.tipoUsuario === 'cliente') {
                document.getElementById('panelCliente').style.display = 'block';
                await cargarEstadisticasCliente();
            } else if (usuario.tipoUsuario === 'tecnico') {
                document.getElementById('panelTecnico').style.display = 'block';
                await cargarEstadisticasTecnico();
            }
        }

        // Ejecutar al cargar la página
        inicializar();

        // Actualizar datos cada 5 minutos
        setInterval(() => {
            if (usuario?.tipoUsuario === 'cliente') {
                cargarEstadisticasCliente();
            } else if (usuario?.tipoUsuario === 'tecnico') {
                cargarEstadisticasTecnico();
            }
        }, 300000); // 5 minutos
    </script>
</body>
</html>