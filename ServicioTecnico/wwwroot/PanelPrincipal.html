<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REVTEC - Panel Principal</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

            .header-logo h1 {
                font-size: 1.5rem;
                color: #1e293b;
                font-weight: 700;
            }

            .header-logo img {
                width: 45px;
                height: 45px;
                border-radius: 50%;
                object-fit: cover;
            }

        .header-subtitle {
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 500;
        }

        .nav-menu {
            list-style: none;
            display: flex;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.9);
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            margin: 1rem 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

            .nav-menu a {
                text-decoration: none;
                color: #475569;
                font-weight: 500;
                padding: 0.5rem 1rem;
                border-radius: 6px;
                transition: all 0.2s;
                cursor: pointer;
            }

                .nav-menu a:hover {
                    background: #ef4444;
                    color: white;
                }

        .welcome-section {
            text-align: center;
            padding: 2rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            background: rgba(255, 255, 255, 0.9);
            margin: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .panel-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: none;
        }

        .panel-title {
            margin-bottom: 1.5rem;
            color: #1e293b;
            font-weight: 700;
            font-size: 1.5rem;
        }

        .panel-links {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .panel-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            text-decoration: none;
            color: #374151;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

            .panel-link:hover {
                background: #3b82f6;
                color: white;
                border-color: #3b82f6;
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
            }

            .panel-link.cliente:hover {
                background: #059669;
                border-color: #059669;
                box-shadow: 0 8px 25px rgba(5, 150, 105, 0.3);
            }

            .panel-link.tecnico:hover {
                background: #7c3aed;
                border-color: #7c3aed;
                box-shadow: 0 8px 25px rgba(124, 58, 237, 0.3);
            }

        .summary-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 12px;
            border-left: 4px solid #3b82f6;
        }

        .summary-title {
            margin: 0 0 1rem 0;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .stat-card {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
        }

        .citas-section {
            margin-top: 1.5rem;
        }

        .citas-title {
            margin: 0 0 1rem 0;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .cita-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 0.75rem;
            border-left: 4px solid #3b82f6;
        }

        .cita-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .cita-vehicle {
            font-weight: 600;
            color: #1e293b;
        }

        .cita-time {
            background: #3b82f6;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .cita-details {
            font-size: 0.9rem;
            color: #64748b;
        }

        .cita-observations {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 0.5rem;
            font-style: italic;
        }

        .loading-text {
            text-align: center;
            color: #64748b;
            font-style: italic;
            padding: 2rem;
        }

        .error-text {
            color: #ef4444;
            text-align: center;
            padding: 1rem;
        }

        .no-data {
            text-align: center;
            color: #64748b;
            font-style: italic;
            padding: 2rem;
        }

        .debug-info {
            background: #f3f4f6;
            padding: 1rem;
            margin: 1rem 2rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.8rem;
            border-left: 4px solid #10b981;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 0.5rem;
            }

            .nav-menu {
                margin: 0.5rem 1rem;
                justify-content: center;
            }

            .panel-section {
                margin: 1rem;
                padding: 1.5rem;
            }

            .panel-links {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .welcome-section {
                margin: 1rem;
                padding: 1.5rem;
                font-size: 1.1rem;
            }
        }

        @media (max-width: 480px) {
            .nav-menu {
                flex-direction: column;
                gap: 0.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .cita-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-logo">
            <img src="39d17164-550e-4c01-a02a-60937f850308.jpg" alt="Logo REVTEC">
            <h1>REVTEC</h1>
        </div>
        <div class="header-subtitle">
            Panel de Control
        </div>
    </header>

    <ul class="nav-menu">
        <li><a href="#" onclick="cerrarSesion()">🚪 Cerrar Sesión</a></li>
    </ul>

    <div id="bienvenida" class="welcome-section">
        <span>Cargando información del usuario...</span>
    </div>

    <!-- Información de debug -->
    <div id="debugInfo" class="debug-info" style="display: none;">
        <strong>🔧 Información de Debug:</strong><br>
        <span id="debugContent"></span>
    </div>

    <!-- Panel del Cliente -->
    <div class="panel-section" id="panelCliente">
        <h2 class="panel-title">👤 Panel del Cliente</h2>
        <div class="panel-links">
            <a href="RegistroVehiculo.html" class="panel-link cliente">
                🚗 Registrar Vehículo
            </a>
            <a href="AgendarCita.html" class="panel-link cliente">
                📅 Agendar Cita
            </a>
            <a href="HistorialInspecciones.html" class="panel-link cliente">
                📋 Ver Historial
            </a>
        </div>

        <!-- Resumen rápido para cliente -->
        <div class="summary-section">
            <h3 class="summary-title">📊 Resumen Rápido</h3>
            <div id="estadisticasCliente" class="stats-grid">
                <div class="loading-text">Cargando estadísticas...</div>
            </div>
        </div>
    </div>

    <!-- Panel del Técnico -->
    <div class="panel-section" id="panelTecnico">
        <h2 class="panel-title">🔧 Panel del Técnico</h2>
        <div class="panel-links">
            <a href="RegistrarInspeccion.html" class="panel-link tecnico">
                ✅ Registrar Inspección
            </a>
            <a href="HistorialInspecciones.html" class="panel-link tecnico">
                📈 Ver Inspecciones
            </a>
        </div>

        <!-- Resumen rápido para técnico -->
        <div class="summary-section" style="background: rgba(139, 92, 246, 0.1); border-left: 4px solid #8b5cf6;">
            <h3 class="summary-title">📊 Actividad del Día</h3>
            <div id="estadisticasTecnico" class="stats-grid">
                <div class="loading-text">Cargando estadísticas...</div>
            </div>
        </div>

        <!-- Citas de hoy -->
        <div id="citasHoy" class="citas-section">
            <h3 class="citas-title">📅 Citas de Hoy</h3>
            <div id="listaCitasHoy">
                <div class="loading-text">Cargando citas...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.protocol + '//' + window.location.host + '/api';
        let usuario = null;

        // Función mejorada para verificar sesión
        function verificarSesion() {
            console.log('🔍 Verificando sesión...');

            try {
                const usuarioActual = localStorage.getItem('usuarioActual');
                console.log('📦 LocalStorage data:', usuarioActual);

                if (!usuarioActual) {
                    console.log('❌ No hay datos de usuario en localStorage');
                    mostrarDebug('No hay datos de usuario en localStorage');
                    window.location.href = 'Login.html';
                    return null;
                }

                const usuarioData = JSON.parse(usuarioActual);
                console.log('👤 Usuario parseado:', usuarioData);

                // Verificar que el objeto tiene las propiedades necesarias
                if (!usuarioData.id || !usuarioData.nombre || !usuarioData.apellidos || !usuarioData.tipoUsuario) {
                    console.log('❌ Datos de usuario incompletos:', usuarioData);
                    mostrarDebug(`Datos incompletos: ${JSON.stringify(usuarioData)}`);

                    // Limpiar localStorage corrupto
                    localStorage.removeItem('usuarioActual');
                    window.location.href = 'Login.html';
                    return null;
                }

                // Verificar si la sesión no ha expirado
                if (usuarioData.loginTime) {
                    const loginTime = new Date(usuarioData.loginTime);
                    const ahora = new Date();
                    const horasTranscurridas = (ahora - loginTime) / (1000 * 60 * 60);

                    if (horasTranscurridas > 24) {
                        console.log('⏰ Sesión expirada');
                        localStorage.removeItem('usuarioActual');
                        window.location.href = 'Login.html';
                        return null;
                    }
                }

                console.log('✅ Sesión válida para:', usuarioData.nombre, usuarioData.apellidos);
                mostrarDebug(`Usuario: ${usuarioData.nombre} ${usuarioData.apellidos} (${usuarioData.tipoUsuario})`);

                return usuarioData;

            } catch (error) {
                console.error('💥 Error al verificar sesión:', error);
                mostrarDebug(`Error: ${error.message}`);

                // Limpiar localStorage corrupto
                localStorage.removeItem('usuarioActual');
                window.location.href = 'Login.html';
                return null;
            }
        }

        function mostrarDebug(mensaje) {
            const debugInfo = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            debugContent.textContent = mensaje;
            debugInfo.style.display = 'block';

            // Ocultar después de 5 segundos
            setTimeout(() => {
                debugInfo.style.display = 'none';
            }, 5000);
        }

        function cerrarSesion() {
            if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
                console.log('🚪 Cerrando sesión...');
                localStorage.removeItem('usuarioActual');
                window.location.href = 'Login.html';
            }
        }

        // Cargar estadísticas para cliente
        async function cargarEstadisticasCliente() {
            try {
                console.log('📊 Cargando estadísticas del cliente...');

                const [vehiculosRes, citasRes, inspeccionesRes, certificadosRes] = await Promise.all([
                    fetch(`${API_BASE}/Vehiculo/porPropietario/${usuario.id}`),
                    fetch(`${API_BASE}/Cita`),
                    fetch(`${API_BASE}/Inspeccion`),
                    fetch(`${API_BASE}/Certificado`)
                ]);

                if (!vehiculosRes.ok) {
                    throw new Error(`Error al cargar vehículos: ${vehiculosRes.status}`);
                }

                const vehiculos = await vehiculosRes.json();
                const todasCitas = await citasRes.json();
                const todasInspecciones = await inspeccionesRes.json();
                const todosCertificados = await certificadosRes.json();

                // Filtrar citas del usuario
                const citasUsuario = todasCitas.filter(c =>
                    vehiculos.some(v => v.idVehiculo === c.idVehiculo)
                );

                // Filtrar inspecciones del usuario
                const inspeccionesUsuario = todasInspecciones.filter(i =>
                    citasUsuario.some(c => c.idCita === i.idCita)
                );

                // Certificados válidos
                const certificadosValidos = todosCertificados.filter(cert => {
                    const esDelUsuario = inspeccionesUsuario.some(i => i.idInspeccion === cert.idInspeccion);
                    const esValido = new Date(cert.fechaVencimiento) > new Date();
                    return esDelUsuario && esValido && cert.estadoCertificado === 'valido';
                });

                // Citas pendientes
                const citasPendientes = citasUsuario.filter(c => c.estadoCita === 'programada');

                const stats = [
                    { titulo: 'Vehículos', valor: vehiculos.length, icono: '🚗', color: '#3b82f6' },
                    { titulo: 'Citas Pendientes', valor: citasPendientes.length, icono: '📅', color: '#f59e0b' },
                    { titulo: 'Inspecciones', valor: inspeccionesUsuario.length, icono: '🔍', color: '#8b5cf6' },
                    { titulo: 'Certificados Válidos', valor: certificadosValidos.length, icono: '✅', color: '#10b981' }
                ];

                const contenedor = document.getElementById('estadisticasCliente');
                contenedor.innerHTML = stats.map(stat => `
                        <div class="stat-card">
                            <div class="stat-icon">${stat.icono}</div>
                            <div class="stat-value" style="color: ${stat.color};">${stat.valor}</div>
                            <div class="stat-label">${stat.titulo}</div>
                        </div>
                    `).join('');

                console.log('✅ Estadísticas del cliente cargadas');

            } catch (error) {
                console.error('Error al cargar estadísticas:', error);
                document.getElementById('estadisticasCliente').innerHTML =
                    '<div class="error-text">Error al cargar estadísticas</div>';
            }
        }

        // Cargar estadísticas para técnico
        async function cargarEstadisticasTecnico() {
            try {
                console.log('📊 Cargando estadísticas del técnico...');

                const [citasRes, inspeccionesRes] = await Promise.all([
                    fetch(`${API_BASE}/Cita`),
                    fetch(`${API_BASE}/Inspeccion`)
                ]);

                const todasCitas = await citasRes.json();
                const todasInspecciones = await inspeccionesRes.json();

                const hoy = new Date().toISOString().split('T')[0];

                // Citas de hoy
                const citasHoy = todasCitas.filter(c =>
                    c.fechaCita.split('T')[0] === hoy && c.estadoCita === 'programada'
                );

                // Inspecciones del técnico
                const inspeccionesTecnico = todasInspecciones.filter(i => i.idTecnico === usuario.id);

                // Inspecciones de hoy
                const inspeccionesHoy = inspeccionesTecnico.filter(i =>
                    i.fechaInspeccion.split('T')[0] === hoy
                );

                // Inspecciones aprobadas hoy
                const aprobadasHoy = inspeccionesHoy.filter(i => i.resultado === 'aprobado').length;

                const stats = [
                    { titulo: 'Citas Hoy', valor: citasHoy.length, icono: '📅', color: '#3b82f6' },
                    { titulo: 'Inspecciones Hoy', valor: inspeccionesHoy.length, icono: '🔍', color: '#8b5cf6' },
                    { titulo: 'Aprobadas Hoy', valor: aprobadasHoy, icono: '✅', color: '#10b981' },
                    { titulo: 'Total Inspecciones', valor: inspeccionesTecnico.length, icono: '📊', color: '#f59e0b' }
                ];

                const contenedor = document.getElementById('estadisticasTecnico');
                contenedor.innerHTML = stats.map(stat => `
                        <div class="stat-card">
                            <div class="stat-icon">${stat.icono}</div>
                            <div class="stat-value" style="color: ${stat.color};">${stat.valor}</div>
                            <div class="stat-label">${stat.titulo}</div>
                        </div>
                    `).join('');

                // Mostrar citas de hoy
                await mostrarCitasHoy(citasHoy);

                console.log('✅ Estadísticas del técnico cargadas');

            } catch (error) {
                console.error('Error al cargar estadísticas:', error);
                document.getElementById('estadisticasTecnico').innerHTML =
                    '<div class="error-text">Error al cargar estadísticas</div>';
            }
        }

        // Mostrar citas de hoy para técnico
        async function mostrarCitasHoy(citasHoy) {
            try {
                const listContainer = document.getElementById('listaCitasHoy');

                if (citasHoy.length === 0) {
                    listContainer.innerHTML = '<div class="no-data">No hay citas programadas para hoy</div>';
                    return;
                }

                const [vehiculosRes, estacionesRes] = await Promise.all([
                    fetch(`${API_BASE}/Vehiculo`),
                    fetch(`${API_BASE}/Estacion`)
                ]);

                const vehiculos = await vehiculosRes.json();
                const estaciones = await estacionesRes.json();

                const citasHTML = citasHoy.map(cita => {
                    const vehiculo = vehiculos.find(v => v.idVehiculo === cita.idVehiculo);
                    const estacion = estaciones.find(e => e.idEstacion === cita.idEstacion);

                    return `
                            <div class="cita-card">
                                <div class="cita-header">
                                    <div class="cita-vehicle">
                                        🚗 ${vehiculo?.numeroPlaca || 'N/A'} - ${vehiculo?.marca || ''} ${vehiculo?.modelo || ''}
                                    </div>
                                    <div class="cita-time">${cita.horaCita}</div>
                                </div>
                                <div class="cita-details">
                                    📍 ${estacion?.nombreEstacion || 'N/A'}
                                </div>
                                ${cita.observaciones ? `<div class="cita-observations">💬 ${cita.observaciones}</div>` : ''}
                            </div>
                        `;
                }).join('');

                listContainer.innerHTML = citasHTML;

            } catch (error) {
                console.error('Error al cargar citas:', error);
                document.getElementById('listaCitasHoy').innerHTML =
                    '<div class="error-text">Error al cargar citas de hoy</div>';
            }
        }

        // Función principal de inicialización
        async function inicializar() {
            console.log('🚀 Inicializando panel principal...');

            // Verificar sesión primero
            usuario = verificarSesion();
            if (!usuario) {
                console.log('❌ No se pudo verificar la sesión');
                return;
            }

            // Mostrar bienvenida personalizada
            const horaActual = new Date().getHours();
            let saludo = '';
            if (horaActual < 12) saludo = '🌅 Buenos días';
            else if (horaActual < 18) saludo = '☀️ Buenas tardes';
            else saludo = '🌙 Buenas noches';

            const nombreCompleto = `${usuario.nombre || ''} ${usuario.apellidos || ''}`.trim();

            if (nombreCompleto) {
                document.getElementById('bienvenida').innerHTML = `${saludo}, <strong>${nombreCompleto}</strong>!`;
            } else {
                document.getElementById('bienvenida').innerHTML = `${saludo}, <strong>Usuario</strong>!`;
                mostrarDebug('Nombre de usuario no disponible');
            }

            // Mostrar panel según tipo de usuario y cargar datos
            if (usuario.tipoUsuario === 'cliente') {
                console.log('👤 Configurando panel de cliente');
                document.getElementById('panelCliente').style.display = 'block';
                await cargarEstadisticasCliente();
            } else if (usuario.tipoUsuario === 'tecnico') {
                console.log('🔧 Configurando panel de técnico');
                document.getElementById('panelTecnico').style.display = 'block';
                await cargarEstadisticasTecnico();
            } else {
                console.log('❌ Tipo de usuario desconocido:', usuario.tipoUsuario);
                mostrarDebug(`Tipo de usuario desconocido: ${usuario.tipoUsuario}`);
            }

            console.log('✅ Inicialización completada');
        }

        // Ejecutar al cargar la página
        document.addEventListener('DOMContentLoaded', inicializar);

        // Actualizar datos cada 5 minutos
        setInterval(() => {
            if (usuario?.tipoUsuario === 'cliente') {
                cargarEstadisticasCliente();
            } else if (usuario?.tipoUsuario === 'tecnico') {
                cargarEstadisticasTecnico();
            }
        }, 300000); // 5 minutos
    </script>
</body>
</html>