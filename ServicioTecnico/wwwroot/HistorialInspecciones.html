<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REVTEC - Historial de Inspecciones</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

            .header-logo h1 {
                font-size: 1.5rem;
                color: #1e293b;
                font-weight: 700;
            }

            .header-logo img {
                width: 45px;
                height: 45px;
                border-radius: 50%;
                object-fit: cover;
            }

        .nav-menu {
            list-style: none;
            display: flex;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.9);
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            margin: 1rem 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

            .nav-menu a {
                text-decoration: none;
                color: #475569;
                font-weight: 500;
                padding: 0.5rem 1rem;
                border-radius: 6px;
                transition: all 0.2s;
            }

                .nav-menu a:hover {
                    background: #3b82f6;
                    color: white;
                }

        .main-container {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .content-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .page-title {
            margin-bottom: 2rem;
            color: #1e293b;
            font-size: 1.75rem;
            font-weight: 700;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #3b82f6;
        }

        .stat-icon {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 500;
        }

        .loading-section {
            text-align: center;
            margin: 2rem 0;
        }

        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #e5e7eb;
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .no-data {
            text-align: center;
            margin: 2rem 0;
            display: none;
        }

        .no-data-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .no-data-text {
            color: #64748b;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .inspections-grid {
            display: grid;
            gap: 1rem;
            margin-top: 2rem;
        }

        .inspection-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #10b981;
            transition: all 0.2s;
        }

            .inspection-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            }

            .inspection-card.rejected {
                border-left-color: #ef4444;
            }

        .inspection-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .inspection-id {
            background: #3b82f6;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .inspection-date {
            color: #64748b;
            font-weight: 500;
        }

        .inspection-result {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .result-aprobado {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .result-rechazado {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .inspection-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .detail-item {
            background: #f8fafc;
            padding: 0.75rem;
            border-radius: 6px;
        }

        .detail-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            color: #1e293b;
            font-weight: 500;
        }

        .certificate-info {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #0ea5e9;
            margin-top: 1rem;
        }

        .certificate-title {
            font-weight: 600;
            color: #0c4a6e;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .certificate-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
        }

        .certificate-item {
            font-size: 0.85rem;
        }

        .certificate-label {
            font-weight: 500;
            color: #075985;
        }

        .certificate-value {
            color: #0c4a6e;
        }

        .status-vigente {
            color: #10b981;
            font-weight: 600;
        }

        .status-vencido {
            color: #ef4444;
            font-weight: 600;
        }

        .message {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-weight: 500;
            text-align: center;
        }

            .message.success {
                background: #dcfce7;
                color: #166534;
                border: 1px solid #bbf7d0;
            }

            .message.info {
                background: #dbeafe;
                color: #1e40af;
                border: 1px solid #93c5fd;
            }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 0.5rem;
            }

            .nav-menu {
                margin: 0.5rem 1rem;
                justify-content: center;
            }

            .main-container {
                padding: 1rem;
            }

            .content-card {
                padding: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .inspection-details {
                grid-template-columns: 1fr;
            }

            .certificate-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-logo">
            <img src="39d17164-550e-4c01-a02a-60937f850308.jpg" alt="Logo REVTEC">
            <h1>REVTEC</h1>
        </div>
    </header>

    <ul class="nav-menu">
        <li><a href="PanelPrincipal.html"> Página Principal</a></li>
        <li><a href="RegistrarInspeccion.html"> Registrar Inspección</a></li>
    </ul>

    <main class="main-container">
        <div class="content-card">
            <h2 class="page-title"> Inspecciones Realizadas</h2>

            <!-- Estadísticas rápidas -->
            <div id="estadisticasRapidas" class="stats-grid">
                <!-- Se llenará dinámicamente -->
            </div>

            <div id="cargando" class="loading-section">
                <div class="loading-spinner"></div>
                <p style="color: #64748b;">Cargando inspecciones...</p>
            </div>

            <div id="sinDatos" class="no-data">
                <div class="no-data-icon"></div>
                <p class="no-data-text">No has realizado inspecciones aún</p>
                <p style="color: #64748b; font-size: 0.9rem;">
                    Ve a <strong>"Registrar Inspección"</strong> para realizar tu primera inspección técnica
                </p>
            </div>

            <div id="mensaje"></div>

            <div id="inspeccionesContainer" class="inspections-grid">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
    </main>

    <script>
        const API_BASE = window.location.protocol + '//' + window.location.host + '/api';
        let usuario = null;
        let inspecciones = [];

        // Verificar sesión
        function verificarSesion() {
            const usuarioActual = localStorage.getItem('usuarioActual');
            if (!usuarioActual) {
                window.location.href = 'Login.html';
                return null;
            }
            const user = JSON.parse(usuarioActual);
            if (user.tipoUsuario !== 'tecnico') {
                window.location.href = 'PanelPrincipal.html';
                return null;
            }
            return user;
        }

        // Cargar inspecciones del técnico
        async function cargarInspecciones() {
            try {
                document.getElementById('cargando').style.display = 'block';
                document.getElementById('inspeccionesContainer').style.display = 'none';
                document.getElementById('sinDatos').style.display = 'none';

                console.log(' Cargando inspecciones para técnico ID:', usuario.id);

                // Cargar inspecciones
                const inspeccionesRes = await fetch(`${API_BASE}/Inspeccion`);
                if (!inspeccionesRes.ok) {
                    throw new Error(`Error ${inspeccionesRes.status}: ${inspeccionesRes.statusText}`);
                }

                const todasInspecciones = await inspeccionesRes.json();
                console.log(' Total inspecciones en sistema:', todasInspecciones.length);

                // Filtrar inspecciones del técnico
                const misInspecciones = todasInspecciones.filter(i =>
                    i.idTecnico === usuario.id || i.IdTecnico === usuario.id
                );
                console.log(' Mis inspecciones:', misInspecciones.length);

                if (misInspecciones.length === 0) {
                    mostrarMensajeNoInspecciones();
                    return;
                }

                // Cargar datos adicionales
                const [vehiculosRes, usuariosRes, citasRes, estacionesRes] = await Promise.all([
                    fetch(`${API_BASE}/Vehiculo`).catch(() => ({ ok: false })),
                    fetch(`${API_BASE}/Usuario`).catch(() => ({ ok: false })),
                    fetch(`${API_BASE}/Cita`).catch(() => ({ ok: false })),
                    fetch(`${API_BASE}/Estacion`).catch(() => ({ ok: false }))
                ]);

                const vehiculos = vehiculosRes.ok ? await vehiculosRes.json() : [];
                const usuarios = usuariosRes.ok ? await usuariosRes.json() : [];
                const citas = citasRes.ok ? await citasRes.json() : [];
                const estaciones = estacionesRes.ok ? await estacionesRes.json() : [];

                console.log(' Datos adicionales cargados:', {
                    vehiculos: vehiculos.length,
                    usuarios: usuarios.length,
                    citas: citas.length,
                    estaciones: estaciones.length
                });

                // Enriquecer inspecciones
                inspecciones = misInspecciones.map(inspeccion => {
                    const cita = citas.find(c => c.idCita === inspeccion.idCita);
                    const vehiculo = vehiculos.find(v => v.idVehiculo === cita?.idVehiculo);
                    const propietario = usuarios.find(u => u.idUsuario === vehiculo?.idPropietario);
                    const estacion = estaciones.find(e => e.idEstacion === cita?.idEstacion);

                    return {
                        ...inspeccion,
                        cita,
                        vehiculo,
                        propietario,
                        estacion
                    };
                });

                // Ordenar por fecha más reciente
                inspecciones.sort((a, b) => new Date(b.fechaInspeccion) - new Date(a.fechaInspeccion));

                mostrarEstadisticas();
                mostrarInspecciones();

            } catch (error) {
                console.error(' Error al cargar inspecciones:', error);
                mostrarError(error);
            }
        }

        // Mostrar estadísticas
        function mostrarEstadisticas() {
            const total = inspecciones.length;
            const aprobadas = inspecciones.filter(i => i.resultado === 'aprobado').length;
            const rechazadas = inspecciones.filter(i => i.resultado === 'rechazado').length;
            const conCertificado = inspecciones.filter(i => i.numeroCertificado).length;

            const stats = [
                { titulo: 'Total', valor: total, icono: '', color: '#3b82f6' },
                { titulo: 'Aprobadas', valor: aprobadas, icono: '', color: '#10b981' },
                { titulo: 'Rechazadas', valor: rechazadas, icono: '', color: '#ef4444' },
                { titulo: 'Con Certificado', valor: conCertificado, icono: '', color: '#8b5cf6' }
            ];

            document.getElementById('estadisticasRapidas').innerHTML = stats.map(stat => `
                    <div class="stat-card">
                        <div class="stat-icon">${stat.icono}</div>
                        <div class="stat-value" style="color: ${stat.color};">${stat.valor}</div>
                        <div class="stat-label">${stat.titulo}</div>
                    </div>
                `).join('');
        }

        // Mostrar inspecciones
        function mostrarInspecciones() {
            document.getElementById('cargando').style.display = 'none';
            document.getElementById('inspeccionesContainer').style.display = 'block';

            if (inspecciones.length === 0) {
                mostrarMensajeNoInspecciones();
                return;
            }

            const container = document.getElementById('inspeccionesContainer');
            container.innerHTML = inspecciones.map(inspeccion => {
                const fechaInspeccion = new Date(inspeccion.fechaInspeccion).toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const fechaVencimiento = inspeccion.fechaVencimiento ?
                    new Date(inspeccion.fechaVencimiento).toLocaleDateString('es-ES') : 'N/A';

                const estaVigente = inspeccion.fechaVencimiento ?
                    new Date(inspeccion.fechaVencimiento) > new Date() : false;

                return `
                        <div class="inspection-card ${inspeccion.resultado === 'rechazado' ? 'rejected' : ''}">
                            <div class="inspection-header">
                                <div class="inspection-id">ID: ${inspeccion.idInspeccion}</div>
                                <div class="inspection-date"> ${fechaInspeccion}</div>
                                <div class="inspection-result result-${inspeccion.resultado}">
                                    ${inspeccion.resultado === 'aprobado' ? ' APROBADO' : ' RECHAZADO'}
                                </div>
                            </div>

                            <div class="inspection-details">
                                <div class="detail-item">
                                    <div class="detail-label"> Vehículo</div>
                                    <div class="detail-value">
                                        ${inspeccion.vehiculo ?
                        `${inspeccion.vehiculo.numeroPlaca} - ${inspeccion.vehiculo.marca} ${inspeccion.vehiculo.modelo}` :
                        'N/A'
                    }
                                    </div>
                                </div>

                                <div class="detail-item">
                                    <div class="detail-label"> Propietario</div>
                                    <div class="detail-value">
                                        ${inspeccion.propietario ?
                        `${inspeccion.propietario.nombre} ${inspeccion.propietario.apellidos}` :
                        'N/A'
                    }
                                    </div>
                                </div>

                                <div class="detail-item">
                                    <div class="detail-label"> Estación</div>
                                    <div class="detail-value">
                                        ${inspeccion.estacion?.nombreEstacion || 'N/A'}
                                    </div>
                                </div>

                                <div class="detail-item">
                                    <div class="detail-label"> Cita</div>
                                    <div class="detail-value">
                                        ${inspeccion.cita ?
                        `ID: ${inspeccion.cita.idCita} - ${new Date(inspeccion.cita.fechaCita).toLocaleDateString('es-ES')}` :
                        'N/A'
                    }
                                    </div>
                                </div>
                            </div>

                            ${inspeccion.observacionesTecnicas ? `
                                <div class="detail-item" style="grid-column: 1 / -1;">
                                    <div class="detail-label"> Observaciones</div>
                                    <div class="detail-value">${inspeccion.observacionesTecnicas}</div>
                                </div>
                            ` : ''}

                            ${inspeccion.numeroCertificado ? `
                                <div class="certificate-info">
                                    <div class="certificate-title"> Información del Certificado</div>
                                    <div class="certificate-details">
                                        <div class="certificate-item">
                                            <span class="certificate-label">Número:</span>
                                            <span class="certificate-value">${inspeccion.numeroCertificado}</span>
                                        </div>
                                        <div class="certificate-item">
                                            <span class="certificate-label">Vencimiento:</span>
                                            <span class="certificate-value">${fechaVencimiento}</span>
                                        </div>
                                        <div class="certificate-item">
                                            <span class="certificate-label">Estado:</span>
                                            <span class="certificate-value ${estaVigente ? 'status-vigente' : 'status-vencido'}">
                                                ${estaVigente ? ' Vigente' : ' Vencido'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
            }).join('');

            mostrarMensaje(' Inspecciones cargadas correctamente', 'success');
        }

        // Mostrar mensaje cuando no hay inspecciones
        function mostrarMensajeNoInspecciones() {
            document.getElementById('cargando').style.display = 'none';
            document.getElementById('inspeccionesContainer').style.display = 'none';
            document.getElementById('sinDatos').style.display = 'block';

            // Mostrar estadísticas vacías
            mostrarEstadisticas();
        }

        // Mostrar error
        function mostrarError(error) {
            document.getElementById('cargando').innerHTML = `
                    <div style="text-align: center; color: #ef4444;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;"></div>
                        <p style="font-weight: 600; margin-bottom: 0.5rem;">Error al cargar inspecciones</p>
                        <p style="font-size: 0.9rem; margin-bottom: 1rem;">${error.message}</p>
                        <button onclick="cargarInspecciones()" style="
                            background: #3b82f6;
                            color: white;
                            border: none;
                            padding: 0.5rem 1rem;
                            border-radius: 6px;
                            cursor: pointer;
                            font-weight: 500;
                        ">
                             Reintentar
                        </button>
                    </div>
                `;
        }

        // Mostrar mensaje
        function mostrarMensaje(texto, tipo) {
            const mensaje = document.getElementById('mensaje');
            mensaje.innerHTML = `<div class="message ${tipo}">${texto}</div>`;

            setTimeout(() => {
                mensaje.innerHTML = '';
            }, 5000);
        }

        // Inicializar página
        async function inicializar() {
            usuario = verificarSesion();
            if (!usuario) return;

            console.log(' Inicializando historial para técnico:', usuario.nombre, usuario.apellidos);
            await cargarInspecciones();
        }

        // Ejecutar al cargar la página
        document.addEventListener('DOMContentLoaded', inicializar);
    </script>
</body>
</html>